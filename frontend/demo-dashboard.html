<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Route Optimization - Demo Dashboard</title>

    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .dashboard {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            display: inline-block;
        }

        .connection-status {
            display: inline-block;
            float: right;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-connected {
            background: #10b981;
            color: white;
        }

        .status-disconnected {
            background: #ef4444;
            color: white;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .metric-label {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .metric-change {
            font-size: 12px;
            margin-top: 5px;
        }

        .metric-change.positive {
            color: #10b981;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            max-height: 450px;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #map {
            height: 400px;
            border-radius: 10px;
        }

        .charts-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 450px;
        }

        .chart-wrapper {
            height: 180px;
            margin-bottom: 20px;
        }

        .orders-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .orders-list {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .order-item {
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .order-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .order-info {
            flex: 1;
        }

        .order-id {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }

        .order-service {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
            font-weight: 500;
        }

        .service-barq {
            background: #fbbf24;
            color: #78350f;
        }

        .service-bullet {
            background: #60a5fa;
            color: #1e3a8a;
        }

        .order-status {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-assigned {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-picked_up {
            background: #e0e7ff;
            color: #3730a3;
        }

        .status-delivered {
            background: #d1fae5;
            color: #065f46;
        }

        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .events-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .events-list {
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            margin-top: 15px;
        }

        .event-item {
            padding: 10px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            background: #f9fafb;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        .event-time {
            color: #6b7280;
            font-size: 12px;
        }

        .drivers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
            padding: 5px;
        }

        .driver-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s;
            font-size: 12px;
        }

        .driver-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .driver-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin: 0 auto 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .driver-available {
            background: #10b981;
        }

        .driver-busy {
            background: #f59e0b;
        }

        .driver-offline {
            background: #6b7280;
        }

        .alert-banner {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-warning {
            border-left: 4px solid #f59e0b;
        }

        .alert-danger {
            border-left: 4px solid #ef4444;
        }

        .alert-success {
            border-left: 4px solid #10b981;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        /* LLM Optimization Styles */
        .llm-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .sla-status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }

        .sla-compliant {
            background: #d1fae5;
            color: #065f46;
        }

        .sla-at-risk {
            background: #fef3c7;
            color: #92400e;
        }

        .sla-violated {
            background: #fee2e2;
            color: #991b1b;
        }

        .llm-insights-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 2px solid #667eea;
        }

        .insight-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .insight-label {
            font-weight: 600;
            color: #667eea;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .insight-value {
            color: #333;
            font-size: 14px;
        }

        .route-colors {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .route-color-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .route-color-box {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <h1>ðŸšš AI Route Optimization Demo
                <span class="llm-badge" id="llmBadge" style="display: none;">AI-Powered</span>
            </h1>
            <div class="connection-status status-disconnected" id="connectionStatus">
                Disconnected
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h3 class="section-title">Demo Control Panel</h3>
            <div style="margin-bottom: 15px;">
                <label>Orders per minute: </label>
                <input type="number" id="ordersPerMinute" value="5" min="1" max="20" style="width: 60px;">
                <label style="margin-left: 20px;">Duration (minutes): </label>
                <input type="number" id="durationMinutes" value="5" min="1" max="60" style="width: 60px;">
            </div>
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="startDemo()">
                    Start Demo
                </button>
                <button class="btn btn-danger" onclick="stopDemo()">
                    Stop Demo
                </button>
                <button class="btn btn-primary" onclick="createManualOrder('BARQ')">
                    Create BARQ Order
                </button>
                <button class="btn btn-primary" onclick="createManualOrder('BULLET')">
                    Create BULLET Order
                </button>
            </div>
        </div>

        <!-- Metrics Cards -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Orders</div>
                <div class="metric-value" id="totalOrders">0</div>
                <div class="metric-change positive">+0 last minute</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Completed Orders</div>
                <div class="metric-value" id="completedOrders">0</div>
                <div class="metric-change positive">+0 last minute</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">SLA Compliance</div>
                <div class="metric-value" id="slaCompliance">100%</div>
                <div class="sla-status-badge sla-compliant" id="slaStatusBadge">All Compliant</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Active Drivers</div>
                <div class="metric-value" id="activeDrivers">0</div>
                <div class="metric-change" id="driverUtilization">0% utilized</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Delivery Time</div>
                <div class="metric-value" id="avgDeliveryTime">0m</div>
                <div class="metric-change positive">Within SLA</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Failed Orders</div>
                <div class="metric-value" id="failedOrders">0</div>
                <div class="metric-change negative">0% failure rate</div>
            </div>
        </div>

        <!-- LLM Insights Panel -->
        <div class="llm-insights-panel" id="llmInsightsPanel" style="display: none;">
            <h3 class="section-title">AI Optimization Insights</h3>
            <div id="llmInsightsContent">
                <div class="insight-item">
                    <div class="insight-label">Vehicles Recommended</div>
                    <div class="insight-value" id="vehiclesRecommended">-</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Fleet Utilization</div>
                    <div class="insight-value" id="fleetUtilization">-</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Optimization Strategy</div>
                    <div class="insight-value" id="optimizationStrategy">-</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">AI Recommendations</div>
                    <div class="insight-value" id="aiRecommendations">-</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Map -->
            <div class="map-container">
                <h3 class="section-title">Live Fleet Map
                    <div class="route-colors" id="routeColors" style="display: none;"></div>
                </h3>
                <div id="map"></div>
            </div>

            <!-- Charts -->
            <div class="charts-container">
                <h3 class="section-title">Performance Charts</h3>
                <div class="chart-wrapper">
                    <canvas id="ordersChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="slaChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Active Orders -->
        <div class="orders-container">
            <div class="orders-header">
                <h3 class="section-title">Active Orders</h3>
                <div id="ordersLoading" class="loading-spinner" style="display: none;"></div>
            </div>
            <div class="orders-list" id="ordersList">
                <p style="color: #6b7280;">No active orders yet. Start the demo to generate orders.</p>
            </div>
        </div>

        <!-- Drivers Grid -->
        <div class="orders-container">
            <h3 class="section-title">Driver Fleet Status</h3>
            <div class="drivers-grid" id="driversGrid">
                <p style="color: #6b7280;">No drivers online yet.</p>
            </div>
        </div>

        <!-- Recent Events -->
        <div class="events-container">
            <h3 class="section-title">Recent Events</h3>
            <div class="events-list" id="eventsList">
                <p style="color: #6b7280;">No events yet. Start the demo to see live events.</p>
            </div>
        </div>
    </div>

    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner"></div>

    <script>
        // WebSocket connection
        let ws = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // Map variables
        let map = null;
        let orderMarkers = new Map();
        let driverMarkers = new Map();

        // Chart variables
        let ordersChart = null;
        let slaChart = null;

        // Data storage
        let systemState = {
            orders: [],
            drivers: [],
            metrics: {
                totalOrders: 0,
                completedOrders: 0,
                failedOrders: 0,
                slaCompliance: 100,
                activeDrivers: 0,
                busyDrivers: 0,
                averageDeliveryTime: 0
            }
        };

        // Initialize on page load
        window.onload = function() {
            initializeMap();
            initializeCharts();
            connectWebSocket();
        };

        // Initialize Leaflet map
        function initializeMap() {
            // Center on Riyadh, Saudi Arabia
            map = L.map('map').setView([24.7136, 46.6753], 11);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Add custom markers for different statuses
            window.orderIcon = L.divIcon({
                html: 'ðŸ“¦',
                iconSize: [30, 30],
                className: 'order-marker'
            });

            window.driverIcon = L.divIcon({
                html: 'ðŸš—',
                iconSize: [30, 30],
                className: 'driver-marker'
            });
        }

        // Initialize Chart.js charts
        function initializeCharts() {
            // Orders over time chart
            const ordersCtx = document.getElementById('ordersChart').getContext('2d');
            ordersChart = new Chart(ordersCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Orders Created',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Orders Completed',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });

            // SLA compliance chart
            const slaCtx = document.getElementById('slaChart').getContext('2d');
            slaChart = new Chart(slaCtx, {
                type: 'doughnut',
                data: {
                    labels: ['BARQ On-Time', 'BARQ Late', 'BULLET On-Time', 'BULLET Late'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            '#10b981',
                            '#ef4444',
                            '#60a5fa',
                            '#f59e0b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 8,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        // WebSocket connection
        function connectWebSocket() {
            if (reconnectAttempts >= maxReconnectAttempts) {
                showAlert('Failed to connect to server after multiple attempts', 'danger');
                return;
            }

            ws = new WebSocket('ws://localhost:8081');

            ws.onopen = function() {
                console.log('Connected to WebSocket server');
                isConnected = true;
                reconnectAttempts = 0;
                updateConnectionStatus(true);

                // Subscribe to all events
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    events: ['all']
                }));

                // Request current state
                ws.send(JSON.stringify({
                    type: 'getState'
                }));
            };

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                showAlert('Connection error occurred', 'warning');
            };

            ws.onclose = function() {
                console.log('Disconnected from WebSocket server');
                isConnected = false;
                updateConnectionStatus(false);

                // Attempt to reconnect after 3 seconds
                setTimeout(() => {
                    reconnectAttempts++;
                    connectWebSocket();
                }, 3000);
            };
        }

        // Handle incoming WebSocket messages
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'connection':
                    console.log('Connection established:', message.data);
                    if (message.data.systemState) {
                        updateSystemState(message.data.systemState);
                    }
                    break;

                case 'systemState':
                    updateSystemState(message.data);
                    break;

                case 'orderCreated':
                    handleOrderCreated(message.data.order);
                    break;

                case 'orderAssigned':
                    handleOrderAssigned(message.data);
                    break;

                case 'orderPickedUp':
                    handleOrderPickedUp(message.data);
                    break;

                case 'orderDelivered':
                    handleOrderDelivered(message.data);
                    break;

                case 'orderFailed':
                    handleOrderFailed(message.data);
                    break;

                case 'driverStatusUpdate':
                    handleDriverUpdate(message.data);
                    break;

                case 'metricsUpdate':
                    updateMetrics(message.data);
                    break;

                case 'slaAlert':
                    handleSLAAlert(message.data);
                    break;

                case 'routeOptimized':
                    handleRouteOptimized(message.data);
                    break;

                case 'demoStarted':
                    showAlert('Demo started successfully!', 'success');
                    document.getElementById('ordersLoading').style.display = 'inline-block';
                    break;

                case 'demoStopped':
                    showAlert('Demo stopped', 'success');
                    document.getElementById('ordersLoading').style.display = 'none';
                    break;
            }
        }

        // Update system state
        function updateSystemState(state) {
            if (state.orders) {
                systemState.orders = state.orders;
                updateOrdersList();
            }
            if (state.drivers) {
                systemState.drivers = state.drivers;
                updateDriversGrid();
            }
            if (state.metrics) {
                updateMetrics(state.metrics);
            }
            if (state.recentEvents) {
                state.recentEvents.forEach(event => {
                    addEventToList(event);
                });
            }
        }

        // Order event handlers
        function handleOrderCreated(order) {
            systemState.orders.unshift(order);
            updateOrdersList();
            addOrderToMap(order);
            addEventToList({
                type: 'orderCreated',
                data: `New ${order.serviceType} order: ${order.id.substring(0, 8)}`,
                timestamp: new Date().toISOString()
            });
            updateCharts();
        }

        function handleOrderAssigned(data) {
            const order = systemState.orders.find(o => o.id === data.orderId);
            if (order) {
                order.status = 'assigned';
                order.driverId = data.driverId;
                updateOrdersList();
                updateOrderOnMap(order);
            }
        }

        function handleOrderPickedUp(data) {
            const order = systemState.orders.find(o => o.id === data.orderId);
            if (order) {
                order.status = 'picked_up';
                updateOrdersList();
                updateOrderOnMap(order);
            }
        }

        function handleOrderDelivered(data) {
            const order = systemState.orders.find(o => o.id === data.orderId);
            if (order) {
                order.status = 'delivered';
                updateOrdersList();
                removeOrderFromMap(order.id);
                showAlert(`Order ${order.id.substring(0, 8)} delivered successfully!`, 'success');
            }
            updateCharts();
        }

        function handleOrderFailed(data) {
            const order = systemState.orders.find(o => o.id === data.orderId);
            if (order) {
                order.status = 'failed';
                updateOrdersList();
                removeOrderFromMap(order.id);
                showAlert(`Order ${order.id.substring(0, 8)} failed: ${data.reason}`, 'danger');
            }
        }

        // Driver update handler
        function handleDriverUpdate(driver) {
            const existingIndex = systemState.drivers.findIndex(d => d.driverId === driver.driverId);
            if (existingIndex >= 0) {
                systemState.drivers[existingIndex] = driver;
            } else {
                systemState.drivers.push(driver);
            }
            updateDriversGrid();
            updateDriverOnMap(driver);
        }

        // SLA alert handler
        function handleSLAAlert(alert) {
            showAlert(`SLA Warning: Order ${alert.orderId.substring(0, 8)} - ${alert.message}`, 'warning');
            addEventToList({
                type: 'slaAlert',
                data: alert.message,
                timestamp: new Date().toISOString()
            });
        }

        // Route optimization handler
        function handleRouteOptimized(data) {
            addEventToList({
                type: 'routeOptimized',
                data: `Route optimized for driver ${data.driverId.substring(0, 8)}: ${data.orderCount} orders`,
                timestamp: new Date().toISOString()
            });

            // Display LLM optimization data if available
            if (data.llmOptimization || data.aiPowered) {
                displayLLMOptimization(data);
            }
        }

        // Display LLM optimization insights
        function displayLLMOptimization(data) {
            // Show LLM badge in header
            const llmBadge = document.getElementById('llmBadge');
            if (llmBadge && data.aiPowered) {
                llmBadge.style.display = 'inline-block';
            }

            // Show insights panel if LLM optimization data exists
            const insightsPanel = document.getElementById('llmInsightsPanel');
            if (!insightsPanel || !data.llmOptimization) return;

            insightsPanel.style.display = 'block';

            const llmOpt = data.llmOptimization;

            // Update vehicles recommended
            if (llmOpt.vehicle_assignments) {
                document.getElementById('vehiclesRecommended').textContent =
                    `${llmOpt.vehicle_assignments.length} vehicles`;
            }

            // Update fleet utilization
            if (llmOpt.optimization_metrics && llmOpt.optimization_metrics.utilization_rate) {
                const utilization = (llmOpt.optimization_metrics.utilization_rate * 100).toFixed(1);
                document.getElementById('fleetUtilization').textContent = `${utilization}%`;
            }

            // Update SLA status
            if (llmOpt.optimization_metrics && llmOpt.optimization_metrics.sla_status) {
                updateSLAStatus(llmOpt.optimization_metrics.sla_status);
            }

            // Update optimization strategy
            if (llmOpt.reasoning) {
                document.getElementById('optimizationStrategy').textContent =
                    llmOpt.reasoning.substring(0, 200) + '...';
            }

            // Update AI recommendations
            if (llmOpt.recommendations && llmOpt.recommendations.length > 0) {
                document.getElementById('aiRecommendations').textContent =
                    llmOpt.recommendations.join('. ');
            }

            // Display route colors on map
            if (llmOpt.vehicle_assignments && llmOpt.vehicle_assignments.length > 1) {
                displayRouteColors(llmOpt.vehicle_assignments);
            }
        }

        // Update SLA status badge
        function updateSLAStatus(slaStatus) {
            const badge = document.getElementById('slaStatusBadge');
            if (!badge) return;

            // Remove existing classes
            badge.classList.remove('sla-compliant', 'sla-at-risk', 'sla-violated');

            // Apply appropriate class based on status
            const statusLower = slaStatus.toLowerCase();
            if (statusLower.includes('compliant') || statusLower.includes('all_compliant')) {
                badge.classList.add('sla-compliant');
                badge.textContent = 'All Compliant';
            } else if (statusLower.includes('at_risk')) {
                badge.classList.add('sla-at-risk');
                badge.textContent = 'At Risk';
            } else if (statusLower.includes('violated')) {
                badge.classList.add('sla-violated');
                badge.textContent = 'Violated';
            }
        }

        // Display route colors legend
        function displayRouteColors(vehicleAssignments) {
            const container = document.getElementById('routeColors');
            if (!container) return;

            const colors = ['#667eea', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

            container.innerHTML = vehicleAssignments.slice(0, colors.length).map((assignment, index) => `
                <div class="route-color-item">
                    <div class="route-color-box" style="background: ${colors[index]};"></div>
                    <span>Route ${index + 1} (${assignment.delivery_ids.length} deliveries)</span>
                </div>
            `).join('');

            container.style.display = 'flex';
        }

        // Update metrics display
        function updateMetrics(metrics) {
            systemState.metrics = metrics;

            document.getElementById('totalOrders').textContent = metrics.totalOrders || 0;
            document.getElementById('completedOrders').textContent = metrics.completedOrders || 0;
            document.getElementById('failedOrders').textContent = metrics.failedOrders || 0;
            document.getElementById('activeDrivers').textContent = metrics.activeDrivers || 0;

            const slaPercentage = metrics.slaCompliance || 100;
            document.getElementById('slaCompliance').textContent = slaPercentage.toFixed(1) + '%';

            const avgTime = metrics.averageDeliveryTime || 0;
            document.getElementById('avgDeliveryTime').textContent = Math.round(avgTime) + 'm';

            if (metrics.busyDrivers && metrics.activeDrivers) {
                const utilization = (metrics.busyDrivers / metrics.activeDrivers * 100).toFixed(0);
                document.getElementById('driverUtilization').textContent = utilization + '% utilized';
            }
        }

        // Update orders list
        function updateOrdersList() {
            const container = document.getElementById('ordersList');

            if (systemState.orders.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No active orders yet. Start the demo to generate orders.</p>';
                return;
            }

            const activeOrders = systemState.orders.filter(o =>
                o.status !== 'delivered' && o.status !== 'failed'
            ).slice(0, 10);

            container.innerHTML = activeOrders.map(order => `
                <div class="order-item">
                    <div class="order-info">
                        <span class="order-id">#${order.id.substring(0, 8)}</span>
                        <span class="order-service service-${order.serviceType.toLowerCase()}">${order.serviceType}</span>
                        <div style="margin-top: 5px; color: #6b7280; font-size: 12px;">
                            ${order.pickup.address} â†’ ${order.dropoff.address}
                        </div>
                    </div>
                    <span class="order-status status-${order.status}">${order.status.replace('_', ' ')}</span>
                </div>
            `).join('');
        }

        // Update drivers grid
        function updateDriversGrid() {
            const container = document.getElementById('driversGrid');

            if (systemState.drivers.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No drivers online yet.</p>';
                return;
            }

            container.innerHTML = systemState.drivers.map(driver => `
                <div class="driver-card">
                    <div class="driver-avatar driver-${driver.status}">ðŸš—</div>
                    <div style="font-weight: 600;">${driver.name}</div>
                    <div style="color: #6b7280; font-size: 12px;">${driver.status}</div>
                    ${driver.currentOrders ? `<div style="font-size: 12px; margin-top: 5px;">${driver.currentOrders} orders</div>` : ''}
                </div>
            `).join('');
        }

        // Add event to list
        function addEventToList(event) {
            const container = document.getElementById('eventsList');

            // Clear placeholder if it's the first event
            if (container.innerHTML.includes('No events yet')) {
                container.innerHTML = '';
            }

            const time = new Date(event.timestamp).toLocaleTimeString();
            const eventHtml = `
                <div class="event-item">
                    <div class="event-time">${time}</div>
                    <div>${event.data}</div>
                </div>
            `;

            container.insertAdjacentHTML('afterbegin', eventHtml);

            // Keep only last 20 events
            const events = container.querySelectorAll('.event-item');
            if (events.length > 20) {
                events[events.length - 1].remove();
            }
        }

        // Map functions
        function addOrderToMap(order) {
            if (!map) return;

            const marker = L.marker(
                [order.pickup.coordinates.lat, order.pickup.coordinates.lng],
                { icon: window.orderIcon }
            ).addTo(map);

            marker.bindPopup(`
                <strong>Order ${order.id.substring(0, 8)}</strong><br>
                Service: ${order.serviceType}<br>
                Status: ${order.status}<br>
                From: ${order.pickup.address}
            `);

            orderMarkers.set(order.id, marker);
        }

        function updateOrderOnMap(order) {
            const marker = orderMarkers.get(order.id);
            if (marker) {
                marker.setPopupContent(`
                    <strong>Order ${order.id.substring(0, 8)}</strong><br>
                    Service: ${order.serviceType}<br>
                    Status: ${order.status}<br>
                    Driver: ${order.driverId ? order.driverId.substring(0, 8) : 'Not assigned'}
                `);
            }
        }

        function removeOrderFromMap(orderId) {
            const marker = orderMarkers.get(orderId);
            if (marker) {
                map.removeLayer(marker);
                orderMarkers.delete(orderId);
            }
        }

        function updateDriverOnMap(driver) {
            if (!map || !driver.location) return;

            let marker = driverMarkers.get(driver.driverId);

            if (marker) {
                marker.setLatLng([driver.location.lat, driver.location.lng]);
            } else {
                marker = L.marker(
                    [driver.location.lat, driver.location.lng],
                    { icon: window.driverIcon }
                ).addTo(map);

                driverMarkers.set(driver.driverId, marker);
            }

            marker.bindPopup(`
                <strong>Driver: ${driver.name}</strong><br>
                Status: ${driver.status}<br>
                Orders: ${driver.currentOrders || 0}
            `);
        }

        // Update charts
        function updateCharts() {
            if (!ordersChart || !slaChart) return;

            // Update orders chart
            const now = new Date().toLocaleTimeString();
            if (ordersChart.data.labels.length > 20) {
                ordersChart.data.labels.shift();
                ordersChart.data.datasets[0].data.shift();
                ordersChart.data.datasets[1].data.shift();
            }

            ordersChart.data.labels.push(now);
            ordersChart.data.datasets[0].data.push(systemState.metrics.totalOrders);
            ordersChart.data.datasets[1].data.push(systemState.metrics.completedOrders);
            ordersChart.update();

            // Update SLA chart (mock data for demo)
            const barqOnTime = Math.floor(Math.random() * 20) + 60;
            const barqLate = Math.floor(Math.random() * 5);
            const bulletOnTime = Math.floor(Math.random() * 15) + 40;
            const bulletLate = Math.floor(Math.random() * 3);

            slaChart.data.datasets[0].data = [barqOnTime, barqLate, bulletOnTime, bulletLate];
            slaChart.update();
        }

        // Control functions
        function startDemo() {
            if (!isConnected) {
                showAlert('Not connected to server. Please wait...', 'warning');
                return;
            }

            const ordersPerMinute = document.getElementById('ordersPerMinute').value;
            const duration = document.getElementById('durationMinutes').value;

            fetch('http://localhost:8081/demo/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ordersPerMinute: parseInt(ordersPerMinute),
                    duration: parseInt(duration)
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Demo started:', data);
            })
            .catch(error => {
                console.error('Error starting demo:', error);
                showAlert('Failed to start demo', 'danger');
            });
        }

        function stopDemo() {
            if (!isConnected) {
                showAlert('Not connected to server', 'warning');
                return;
            }

            fetch('http://localhost:8081/demo/stop', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Demo stopped:', data);
            })
            .catch(error => {
                console.error('Error stopping demo:', error);
                showAlert('Failed to stop demo', 'danger');
            });
        }

        function createManualOrder(serviceType) {
            if (!isConnected) {
                showAlert('Not connected to server', 'warning');
                return;
            }

            ws.send(JSON.stringify({
                type: 'createOrder',
                serviceType: serviceType
            }));
        }

        // UI helper functions
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'connection-status status-connected';
                status.textContent = 'Connected';
            } else {
                status.className = 'connection-status status-disconnected';
                status.textContent = 'Disconnected';
            }
        }

        function showAlert(message, type) {
            const banner = document.getElementById('alertBanner');
            banner.className = `alert-banner alert-${type}`;
            banner.textContent = message;
            banner.style.display = 'block';

            setTimeout(() => {
                banner.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>